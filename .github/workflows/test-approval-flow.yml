name: Test Certificate Approval Flow

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ãƒ†ã‚¹ãƒˆç’°å¢ƒ (main/develop)'
        required: false
        type: string
        default: 'main'
      send_slack_notification:
        description: 'Slacké€šçŸ¥ã‚‚ãƒ†ã‚¹ãƒˆã™ã‚‹'
        required: false
        type: boolean
        default: false

env:
  AWS_REGION: ap-northeast-1

jobs:
  test-approval-flow:
    runs-on: ubuntu-latest
    outputs:
      approval_id: ${{ steps.test-flow.outputs.approval_id }}
      environment: ${{ steps.test-flow.outputs.environment }}
      bundle_id: ${{ steps.test-flow.outputs.bundle_id }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Run approval flow test
        id: test-flow
        run: |
          echo "ğŸ§ª æ‰¿èªãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™"
          python scripts/test_approval_flow.py
        env:
          ENVIRONMENT: ${{ github.event.inputs.environment }}
          FORCE_UPDATE: 'true'
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Send test Slack notification
        if: github.event.inputs.send_slack_notification == 'true'
        run: |
          echo "ğŸ“¤ å®Ÿéš›ã®Slacké€šçŸ¥ã‚’ãƒ†ã‚¹ãƒˆé€ä¿¡ã—ã¾ã™"
          python scripts/send_approval_request.py
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          ENVIRONMENT: ${{ steps.test-flow.outputs.environment }}
          BUNDLE_ID: ${{ steps.test-flow.outputs.bundle_id }}
          EXPIRY_DATE: ${{ steps.test-flow.outputs.expiry_date }}
          DAYS_REMAINING: ${{ steps.test-flow.outputs.days_remaining }}
          APPROVAL_ID: ${{ steps.test-flow.outputs.approval_id }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Show test results
        run: |
          echo "âœ… ãƒ†ã‚¹ãƒˆå®Œäº†ï¼"
          echo ""
          echo "ğŸ“‹ ç”Ÿæˆã•ã‚ŒãŸæ‰¿èªæƒ…å ±:"
          echo "  æ‰¿èªID: ${{ steps.test-flow.outputs.approval_id }}"
          echo "  ç’°å¢ƒ: ${{ steps.test-flow.outputs.environment }}"
          echo "  Bundle ID: ${{ steps.test-flow.outputs.bundle_id }}"
          echo ""
          echo "ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
          echo "1. æ‰¿èªãƒ†ã‚¹ãƒˆ: Certificate Update with Approval ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§æ‰‹å‹•å®Ÿè¡Œ"
          echo "   - approval_action: approve"
          echo "   - environment: ${{ steps.test-flow.outputs.environment }}"
          echo "   - approval_id: ${{ steps.test-flow.outputs.approval_id }}"
          echo ""
          echo "2. æ‹’å¦ãƒ†ã‚¹ãƒˆ: åŒã˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ approval_action ã‚’ reject ã«å¤‰æ›´"
          echo ""
          echo "3. ç„¡åŠ¹ãªIDãƒ†ã‚¹ãƒˆ: é–“é•ã£ãŸ approval_id ã§ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ç¢ºèª"

  test-validation:
    runs-on: ubuntu-latest
    needs: test-approval-flow
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Test approval validation (valid)
        run: |
          echo "âœ… æœ‰åŠ¹ãªæ‰¿èªIDã®æ¤œè¨¼ãƒ†ã‚¹ãƒˆ"
          python scripts/validate_approval.py
        env:
          APPROVAL_ACTION: 'approve'
          APPROVAL_ID: ${{ needs.test-approval-flow.outputs.approval_id }}
          ENVIRONMENT: ${{ needs.test-approval-flow.outputs.environment }}

      - name: Test approval validation (invalid ID)
        run: |
          echo "âŒ ç„¡åŠ¹ãªæ‰¿èªIDã®æ¤œè¨¼ãƒ†ã‚¹ãƒˆï¼ˆã‚¨ãƒ©ãƒ¼ãŒæœŸå¾…ã•ã‚Œã‚‹ï¼‰"
          if python scripts/validate_approval.py; then
            echo "âš ï¸  è­¦å‘Š: ç„¡åŠ¹ãªIDãŒé€šã£ã¦ã—ã¾ã„ã¾ã—ãŸ"
            exit 1
          else
            echo "âœ… æ­£å¸¸: ç„¡åŠ¹ãªIDãŒæ­£ã—ãæ‹’å¦ã•ã‚Œã¾ã—ãŸ"
          fi
        env:
          APPROVAL_ACTION: 'approve'
          APPROVAL_ID: 'invalid-test-id'
          ENVIRONMENT: ${{ needs.test-approval-flow.outputs.environment }}

      - name: Test summary
        run: |
          echo "ğŸ‰ æ‰¿èªãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼"
          echo ""
          echo "âœ… å®Œäº†ã—ãŸãƒ†ã‚¹ãƒˆ:"
          echo "  - æ‰¿èªãƒªã‚¯ã‚¨ã‚¹ãƒˆç”Ÿæˆ"
          echo "  - æ‰¿èªIDæ¤œè¨¼ï¼ˆæœ‰åŠ¹ï¼‰"
          echo "  - æ‰¿èªIDæ¤œè¨¼ï¼ˆç„¡åŠ¹ï¼‰"
          echo "  - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°"
          echo ""
          echo "ğŸ”„ æ‰‹å‹•ãƒ†ã‚¹ãƒˆæ¨å¥¨:"
          echo "  - Certificate Update with Approval ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã®å®Ÿéš›ã®æ‰¿èª"
          echo "  - Slacké€šçŸ¥ã®ç¢ºèªï¼ˆsend_slack_notification: trueã§å®Ÿè¡Œï¼‰"